<%= turbo_frame_tag "modal" do %>
  <%= render DS::Dialog.new do |dialog| %>
    <% dialog.with_header(title: t(".title", default: "Link Trade Republic Account")) %>

    <% dialog.with_body do %>
      <div class="space-y-4">
        <p class="text-sm text-secondary">
          <%= t(".description", default: "Select a Trade Republic account to link with %{account_name}.", account_name: @account.name) %>
        </p>

        <form action="<%= link_existing_account_traderepublic_items_path %>" method="post" class="space-y-4" data-turbo-frame="_top">
          <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
          <%= hidden_field_tag :account_id, @account.id %>

          <div class="space-y-2">
            <% @available_accounts.each do |tr_account| %>
              <label class="flex items-start gap-3 p-3 border border-primary rounded-lg hover:bg-subtle cursor-pointer transition-colors">
                <%= radio_button_tag "traderepublic_account_id", tr_account.id, false, class: "mt-1" %>
                <div class="flex-1">
                  <div class="font-medium text-sm text-primary">
                    <%= tr_account.name %>
                  </div>
                  <div class="text-xs text-secondary mt-1">
                    <% if tr_account.current_balance %>
                      <%= number_to_currency(tr_account.current_balance, unit: tr_account.currency, precision: 2) %> •
                    <% end %>
                    <%= tr_account.currency %> • <%= tr_account.account_type&.humanize || "Investment" %>
                  </div>
                </div>
              </label>
            <% end %>
          </div>

          <% if @available_accounts.empty? %>
            <div class="p-4 bg-warning/10 border border-warning rounded-lg">
              <p class="text-sm text-warning">
                <%= icon "alert-triangle", class: "inline-block w-4 h-4 mr-1" %>
                <%= t(".no_accounts", default: "No Trade Republic accounts available. Please connect a new Trade Republic account first.") %>
              </p>
            </div>
          <% end %>

          <div class="flex gap-2 justify-end pt-4">
            <%= link_to t(".cancel", default: "Cancel"), account_path(@account),
                class: "inline-flex items-center gap-1 px-3 py-2 text-sm font-medium rounded-lg text-primary button-bg-secondary hover:button-bg-secondary-hover",
                data: { turbo_frame: "_top", action: "DS--dialog#close" } %>
            <%= submit_tag t(".link_account", default: "Link Account"),
                class: "inline-flex items-center gap-1 px-3 py-2 text-sm font-medium rounded-lg text-inverse bg-inverse hover:bg-inverse-hover disabled:button-bg-disabled",
                disabled: @available_accounts.empty? %>
          </div>
        </form>
      </div>
    <% end %>
  <% end %>
<% end %>
