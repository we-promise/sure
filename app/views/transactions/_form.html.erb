<%# locals: (entry:, income_categories:, expense_categories:) %>

<%= styled_form_with model: entry, url: transactions_path, class: "space-y-4" do |f| %>
  <% if entry.errors.any? %>
    <%= render "shared/form_errors", model: entry %>
  <% end %>

  <section>
    <%= render "shared/transaction_type_tabs", active_tab: params[:nature] == "inflow" ? "income" : "expense", account_id: params[:account_id] %>

    <%= f.hidden_field :nature, value: params[:nature] || "outflow" %>
    <%= f.hidden_field :entryable_type, value: "Transaction" %>
  </section>

  <section class="space-y-2">
    <%= f.text_field :name, label: t(".description"), placeholder: t(".description_placeholder"), required: true %>

    <% if @entry.account_id %>
      <%= f.hidden_field :account_id %>
    <% else %>
      <%= f.collection_select :account_id, Current.family.accounts.manual.active.alphabetically, :id, :name, { prompt: t(".account_prompt"), label: t(".account") }, required: true, class: "form-field__input text-ellipsis" %>
    <% end %>

    <%= f.money_field :amount, label: t(".amount"), required: true %>
    <%= f.fields_for :entryable do |ef| %>
      <% categories = params[:nature] == "inflow" ? income_categories : expense_categories %>
      <%= ef.collection_select :category_id, categories, :id, :name, { prompt: t(".category_prompt"), label: t(".category") } %>
    <% end %>
    <%= f.date_field :date, label: t(".date"), required: true, min: Entry.min_supported_date, max: Date.current, value: Date.current %>
  </section>

  <%= render DS::Disclosure.new(title: t(".details")) do %>
    <%= f.fields_for :entryable do |ef| %>
      <div data-controller="merchant-selector">
        <div data-merchant-selector-target="selectMode">
          <div class="flex items-center gap-1">
            <div class="grow">
              <%= ef.collection_select :merchant_id,
                    Current.family.available_merchants.alphabetically,
                    :id, :name,
                    { prompt: t(".merchant_prompt"), label: t(".merchant_label") },
                    { "data-merchant-selector-target": "merchantSelect" } %>
            </div>
            <button type="button"
                    class="flex items-center justify-center w-8 h-8 rounded-lg text-secondary hover:text-primary hover:bg-surface-inset-hover shrink-0 mt-4"
                    data-action="click->merchant-selector#showNew"
                    title="<%= t(".new_merchant") %>">
              <%= icon "plus", size: "sm" %>
            </button>
          </div>
        </div>
        <div data-merchant-selector-target="newMode" class="hidden">
          <div class="flex items-center gap-1">
            <div class="grow">
              <div class="form-field">
                <div class="form-field__body">
                  <%= label_tag :new_merchant_name, t(".merchant_label"), class: "form-field__label" %>
                  <%= text_field_tag :new_merchant_name, nil, placeholder: t(".new_merchant_placeholder"), class: "form-field__input", data: { merchant_selector_target: "merchantName" } %>
                </div>
              </div>
            </div>
            <button type="button"
                    class="flex items-center justify-center w-8 h-8 rounded-lg text-secondary hover:text-primary hover:bg-surface-inset-hover shrink-0 mt-4"
                    data-action="click->merchant-selector#showSelect"
                    title="<%= t(".cancel") %>">
              <%= icon "x", size: "sm" %>
            </button>
          </div>
        </div>
      </div>

      <%= ef.select :tag_ids,
                    Current.family.tags.alphabetically.pluck(:name, :id),
                    {
                      include_blank: t(".none"),
                      multiple: true,
                      label:    t(".tags_label")
                    },
                    { "data-controller": "multi-select" } %>
    <% end %>
    <%= f.text_area :notes,
                    label: t(".note_label"),
                    placeholder: t(".note_placeholder"),
                    rows: 5,
                    "data-auto-submit-form-target": "auto" %>
  <% end %>

  <section>
    <%= f.submit t(".submit") %>
  </section>
<% end %>
