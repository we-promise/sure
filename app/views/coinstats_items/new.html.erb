<%= turbo_frame_tag "modal" do %>
  <%= render DS::Dialog.new do |dialog| %>
    <% dialog.with_header(title: "Link Crypto Wallet using CoinStats") %>
    
    <% dialog.with_body do %>
        <% items = local_assigns[:coinstats_items] || @coinstats_items || Current.family.coinstats_items.where.not(api_key: nil) %>
        <% if items&.any? %>
          <% selected_item = items.first %>
          <% blockchains = Provider::Coinstats.new(selected_item.api_key).blockchain_options rescue [] %>
          <%= styled_form_with url: link_wallet_coinstats_items_path,
                              method: :post,
                              data: { turbo: true, turbo_frame: "_top" },
                              class: "space-y-3" do |form| %>
            <%= form.hidden_field :coinstats_item_id, value: selected_item.id %>
            
            <%= form.text_field :address,
                                label: "Address",
                                placeholder: "Required"%>

            <% if blockchains.present? %>
              <%= form.select :blockchain,
                              options_for_select(blockchains),
                              { include_blank: "Select blockchain" },
                              label: "Blockchain",
                              class: "w-full rounded-md border border-primary px-3 py-2 text-sm bg-container-inset text-primary" %>
            <% else %>
              <%= form.text_field :blockchain,
                                  label: "Blockchain",
                                  placeholder: "Required"%>
            <% end %>

            <div class="flex justify-end">
              <%= form.submit "Link",
                              class: "inline-flex items-center justify-center rounded-lg px-4 py-2 text-sm font-medium text-white bg-gray-900 hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-900 focus:ring-offset-2 transition-colors" %>
            </div>
          <% end %>
        <% else %>
            <div class="space-y-4">
                <div class="flex items-start gap-3">
                <%= icon("alert-circle", class: "text-warning w-5 h-5 shrink-0 mt-0.5") %>
                <div class="text-sm text-secondary">
                    <p class="font-medium text-primary mb-2">CoinStats not configured</p>
                    <p>To link a crypto wallet with CoinStats, first configure the provider.</p>
                </div>
                </div>

                <div class="bg-surface rounded-lg p-4 space-y-2 text-sm">
                <ol class="list-decimal list-inside space-y-1 text-secondary">
                    <li>Go to <strong>Settings â†’ Providers</strong></li>
                    <li>Find the <strong>CoinStats</strong> section</li>
                    <li>Follow the provided <strong>Setup Instructions</strong></li>
                </ol>
                </div>

                <div class="mt-4">
                <%= link_to settings_providers_path,
                            class: "w-full inline-flex items-center justify-center rounded-lg font-medium whitespace-nowrap rounded-lg hidden md:inline-flex px-3 py-2 text-sm text-inverse bg-inverse hover:bg-inverse-hover disabled:bg-gray-500 theme-dark:disabled:bg-gray-400",
                            data: { turbo: false } do %>
                    Go to Provider Settings
                <% end %>
                </div>
            </div>
        <% end %>
    <% end %>
  <% end %>
<% end %>
