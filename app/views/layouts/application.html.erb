<% mobile_nav_items = [
  { name: t(".nav.home"), path: root_path, icon: "pie-chart", icon_custom: false, active: page_active?(root_path) },
  { name: t(".nav.transactions"), path: transactions_path, icon: "credit-card", icon_custom: false, active: page_active?(transactions_path) },
  { name: t(".nav.reports"), path: reports_path, icon: "chart-bar", icon_custom: false, active: page_active?(reports_path) },
  { name: t(".nav.budgets"), path: budgets_path, icon: "map", icon_custom: false, active: page_active?(budgets_path) },
  { name: t(".nav.assistant"), path: chats_path, icon: "icon-assistant", icon_custom: true, active: page_active?(chats_path), mobile_only: true }
] %>

<% desktop_nav_items = mobile_nav_items.reject { |item| item[:mobile_only] } %>
<% expanded_sidebar_class = "w-full" %>
<% collapsed_sidebar_class = "w-0" %>

<%= render "layouts/shared/htmldoc" do %>
  <div
    class="flex flex-col lg:flex-row h-full bg-surface"
    data-controller="app-layout resizable-layout"
    data-app-layout-expanded-sidebar-class="<%= expanded_sidebar_class %>"
    data-app-layout-collapsed-sidebar-class="<%= collapsed_sidebar_class %>"
    data-app-layout-user-id-value="<%= Current.user.id %>"
    data-resizable-layout-user-id-value="<%= Current.user.id %>"
    data-resizable-layout-left-width-value="<%= Current.user.left_sidebar_width %>"
    data-resizable-layout-right-width-value="<%= Current.user.right_sidebar_width %>">
    <div
      class="hidden fixed inset-0 bg-surface z-20 h-full w-full pt-[calc(env(safe-area-inset-top)+0.75rem)] pr-3 pb-[calc(env(safe-area-inset-bottom)+0.75rem)] pl-3 overflow-y-auto transition-all duration-300"
      data-app-layout-target="mobileSidebar">
      <div class="mb-2">
        <%= icon("x", as_button: true, data: { action: "app-layout#closeMobileSidebar" }) %>
      </div>

      <%= render(
        "accounts/account_sidebar_tabs",
        family: Current.family,
        active_tab: @account_group_tab,
        mobile: true
      ) %>
    </div>

    <%# MOBILE - Top nav %>
    <nav class="lg:hidden flex justify-between items-center p-3">
      <%= icon("panel-left", as_button: true, data: { action: "app-layout#openMobileSidebar"}) %>

      <%= link_to root_path, class: "block" do %>
        <%= image_tag "logomark-color.svg", class: "w-9 h-9 mx-auto" %>
      <% end %>

      <%= render "users/user_menu", user: Current.user, placement: "bottom-end", offset: 12 %>
    </nav>

    <%# DESKTOP - Left navbar %>
    <div class="hidden lg:block">
      <nav class="h-full flex flex-col shrink-0 w-[84px] py-4 mr-3">
        <div class="pl-2 mb-3">
          <%= link_to root_path, class: "block" do %>
            <%= image_tag "logomark-color.svg", class: "w-9 h-9 mx-auto" %>
          <% end %>
        </div>

        <ul class="space-y-0.5">
          <% desktop_nav_items.reject { |item| item[:mobile_only] }.each do |nav_item| %>
            <li>
              <%= render "layouts/shared/nav_item", **nav_item %>
            </li>
          <% end %>
        </ul>

        <div class="pl-2 mt-auto mx-auto flex flex-col gap-2">
          <%= render DS::Link.new(
            variant: "icon",
            icon: "message-circle-question",
            href: "https://discord.gg/36ZGBsxYEK",
            target: "_blank"
          ) %>

          <%= render "users/user_menu", user: Current.user %>
        </div>
      </nav>
    </div>

    <%# DESKTOP - Left sidebar %>
    <%= tag.div class: class_names(
        "hidden lg:block py-4 overflow-y-auto shrink-0 transition-all duration-300",
        Current.user.show_sidebar? ? nil : collapsed_sidebar_class,
       ),
       style: Current.user.show_sidebar? ? "width: #{Current.user.left_sidebar_width}px" : nil,
       data: { app_layout_target: "leftSidebar", resizable_layout_target: "leftSidebar" } do %>
      <% if content_for?(:sidebar) %>
        <div class="w-full h-full">
          <%= yield :sidebar %>
        </div>
      <% else %>
        <div class="h-full w-full flex flex-col">
          <div class="overflow-y-auto grow w-full">
            <%= render "accounts/account_sidebar_tabs", family: Current.family, active_tab: @account_group_tab %>
          </div>

          <% if Current.family.trialing? && !self_hosted? %>
            <div class="px-4 py-3 space-y-4 bg-container shadow-border-xs rounded-xl">
              <div class="flex items-start justify-between">
                <div>
                  <p class="text-sm font-medium text-primary"><%= t("layouts.trial.open_demo") %></p>
                  <p class="text-sm text-secondary"><%= t("layouts.trial.data_deleted_in_days", days: Current.family.days_left_in_trial) %></p>
                </div>

                <%= render DS::Link.new(
                  text: t("layouts.trial.contribute"),
                  href: upgrade_subscription_path,
                ) %>
              </div>

              <div class="flex items-center gap-0.5 h-1.5">
                <div class="h-full bg-warning rounded-full" style="width: <%= Current.family.percentage_of_trial_completed %>%"></div>
                <div class="h-full bg-surface-inset rounded-full" style="width: <%= Current.family.percentage_of_trial_remaining %>%"></div>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    <% end %>

    <%# Left resize handle - visible only when left sidebar is expanded %>
    <%= tag.div class: class_names(
          "lg:flex items-center justify-center w-3 shrink-0 cursor-col-resize group hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors",
          Current.user.show_sidebar? ? "hidden lg:flex" : "hidden"
        ),
        role: "separator",
        aria: { orientation: "vertical", label: t(".resize_left_sidebar") },
        tabindex: "0",
        data: {
          app_layout_target: "leftHandle",
          resizable_layout_target: "leftHandle",
          action: "mousedown->resizable-layout#startLeftDrag touchstart->resizable-layout#startLeftTouch keydown->resizable-layout#handleLeftKeydown"
        } do %>
      <div class="w-0.5 h-full bg-transparent group-hover:bg-primary group-focus:bg-primary transition-colors"></div>
    <% end %>

    <%# SHARED - Main content %>
    <%= tag.main class: class_names("grow overflow-y-auto px-3 lg:px-10 py-4 w-full mx-auto max-w-5xl"), data: { app_layout_target: "content" } do %>
      <div class="hidden lg:flex gap-2 items-center justify-between mb-6">
        <div class="flex items-center gap-2">
          <%= icon("panel-left", as_button: true, data: { action: "app-layout#toggleLeftSidebar" }) %>

          <% if content_for?(:breadcrumbs) %>
            <%= yield :breadcrumbs %>
          <% else %>
            <%= render "layouts/shared/breadcrumbs", breadcrumbs: @breadcrumbs %>
          <% end %>
        </div>
        <%= icon("panel-right", as_button: true, data: { action: "app-layout#toggleRightSidebar" }) %>
      </div>

      <% if content_for?(:page_header) %>
        <%= yield :page_header %>
      <% end %>

      <%= yield %>
    <% end %>

    <%# Right resize handle - visible only when right sidebar is expanded %>
    <%= tag.div class: class_names(
          "lg:flex items-center justify-center w-3 shrink-0 cursor-col-resize group hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors",
          Current.user.show_ai_sidebar? ? "hidden lg:flex" : "hidden"
        ),
        role: "separator",
        aria: { orientation: "vertical", label: t(".resize_right_sidebar") },
        tabindex: "0",
        data: {
          app_layout_target: "rightHandle",
          resizable_layout_target: "rightHandle",
          action: "mousedown->resizable-layout#startRightDrag touchstart->resizable-layout#startRightTouch keydown->resizable-layout#handleRightKeydown"
        } do %>
      <div class="w-0.5 h-full bg-transparent group-hover:bg-primary group-focus:bg-primary transition-colors"></div>
    <% end %>

    <%# DESKTOP - Right sidebar %>
    <%= tag.div class: class_names(
          "hidden lg:block h-full overflow-y-auto shrink-0 transition-all duration-300",
          Current.user.show_ai_sidebar? ? nil : collapsed_sidebar_class,
        ),
        style: Current.user.show_ai_sidebar? ? "width: #{Current.user.right_sidebar_width}px" : nil,
        data: { app_layout_target: "rightSidebar", resizable_layout_target: "rightSidebar" } do %>
      <%= tag.div id: "chat-container", class: "relative h-full w-full", data: { controller: "chat hotkey", turbo_permanent: true } do %>
        <div class="flex flex-col h-full w-full justify-between shrink-0">
          <%= turbo_frame_tag chat_frame, src: chat_view_path(@chat), loading: "lazy", class: "h-full" do %>
            <div class="flex justify-center items-center h-full">
              <%= icon("loader-circle", class: "animate-spin") %>
            </div>
          <% end %>
        </div>

        <% unless Current.user.ai_enabled? %>
          <div class="absolute backdrop-blur-lg inset-0 h-full w-full flex flex-col justify-center items-center pl-0.5 pr-4">
            <%= render "chats/ai_consent" %>
          </div>
        <% end %>
      <% end %>
    <% end %>

    <%# MOBILE - Bottom Nav %>
    <%= tag.nav class: "lg:hidden sticky bottom-0 left-0 right-0 bg-surface z-10 border-t border-tertiary flex justify-around" do %>
      <% mobile_nav_items.each do |nav_item| %>
        <%= render "layouts/shared/nav_item", **nav_item %>
      <% end %>
    <% end %>
  </div>
<% end %>
