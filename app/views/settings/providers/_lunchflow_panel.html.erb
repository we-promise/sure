<div class="space-y-4">
  <div class="prose prose-sm text-secondary">
    <p class="text-primary font-medium">Setup instructions:</p>
    <ol>
      <li>Visit <a href="https://www.lunchflow.app" target="_blank" rel="noopener noreferrer" class="link">Lunch Flow</a> to get your API key</li>
      <li>Paste your API key below (auto-saves when you click outside the field or press Enter)</li>
      <li>After a successful connection, go to the Accounts tab to set up new accounts and link them to your existing ones</li>
    </ol>

    <p class="text-primary font-medium">Field descriptions:</p>
    <ul>
      <li><strong>API Key:</strong> Your Lunch Flow API key for authentication (required)</li>
      <li><strong>Base URL:</strong> Base URL for Lunch Flow API (optional, defaults to https://lunchflow.app/api/v1)</li>
    </ul>
  </div>

  <% error_msg = local_assigns[:error_message] || @error_message %>
  <% if error_msg.present? %>
    <div class="p-2 rounded-md bg-destructive/10 text-destructive text-sm">
      <%= error_msg %>
    </div>
  <% end %>

  <% lunchflow_item = Current.family.lunchflow_items.where.not(api_key: nil).first %>
  <% if lunchflow_item.nil? %>
    <%= styled_form_with model: LunchflowItem.new,
                         url: lunchflow_items_path,
                         scope: :lunchflow_item,
                         method: :post,
                         data: { controller: "auto-submit-form", turbo: true },
                         class: "space-y-3" do |form| %>
      <%= form.text_field :api_key,
                          label: "API Key",
                          placeholder: "Paste API key here (auto-saves on blur)",
                          type: :password,
                          data: { auto_submit_form_target: "auto" } %>

      <%= form.text_field :base_url,
                          label: "Base URL (Optional)",
                          placeholder: "https://lunchflow.app/api/v1 (default)",
                          data: { auto_submit_form_target: "auto" } %>
    <% end %>
  <% else %>
    <%= styled_form_with model: lunchflow_item,
                         url: lunchflow_item_path(lunchflow_item),
                         scope: :lunchflow_item,
                         method: :patch,
                         data: { controller: "auto-submit-form", turbo: true },
                         class: "space-y-3" do |form| %>
      <%= form.text_field :api_key,
                          label: "API Key",
                          placeholder: "Enter new API key to update (auto-saves on blur)",
                          type: :password,
                          data: { auto_submit_form_target: "auto" } %>

      <%= form.text_field :base_url,
                          label: "Base URL (Optional)",
                          placeholder: "https://lunchflow.app/api/v1 (default)",
                          value: lunchflow_item.base_url,
                          data: { auto_submit_form_target: "auto" } %>
    <% end %>
  <% end %>

  <% items = local_assigns[:lunchflow_items] || @lunchflow_items || Current.family.lunchflow_items.where.not(api_key: nil) %>
  <% if items&.any? %>
    <div class="flex items-center gap-2">
      <div class="w-2 h-2 bg-success rounded-full"></div>
      <p class="text-sm text-secondary">Configured and ready to use. Visit the <a href="<%= accounts_path %>" class="link">Accounts</a> tab to manage and set up accounts.</p>
    </div>
  <% end %>
</div>
