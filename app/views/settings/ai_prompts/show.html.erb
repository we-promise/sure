<%= content_for :page_title, t(".page_title") %>

<% if Current.user.ai_enabled? %>
  <div class="mb-4 flex justify-end">
    <%= render DS::Button.new(
      text: t(".disable_ai"),
      href: user_path(Current.user),
      method: :patch,
      params: { user: { ai_enabled: false, redirect_to: "ai_prompts" } },
      data: { turbo: false },
      variant: :destructive
    ) %>
  </div>
<% end %>

<%# Section: Endpoint & model (always visible) %>
<div class="mb-6">
  <div class="bg-container rounded-xl shadow-border-xs p-4">
    <h2 class="text-sm font-medium text-primary mb-1"><%= t(".endpoint_section_title") %></h2>
    <p class="text-xs text-secondary mb-4"><%= t(".endpoint_section_subtitle") %></p>
    <%= styled_form_with model: @family,
                         url: settings_ai_prompts_path,
                         method: :patch,
                         scope: :family,
                         class: "space-y-4" do |form| %>
      <%= form.text_field :openai_uri_base,
                          label: t(".openai_uri_base_label"),
                          placeholder: t(".openai_uri_base_placeholder"),
                          value: @family.openai_uri_base,
                          class: "w-full min-w-0 font-mono text-sm text-primary bg-container placeholder:text-subdued min-h-[2.25rem] px-2 py-1.5 rounded border border-secondary" %>
      <p class="text-xs text-secondary -mt-2"><%= t(".openai_uri_base_hint") %></p>
      <%= form.text_field :preferred_ai_model,
                          label: t(".preferred_ai_model_label"),
                          placeholder: t(".preferred_ai_model_placeholder"),
                          value: @family.preferred_ai_model,
                          class: "w-full min-w-0 font-mono text-sm text-primary bg-container placeholder:text-subdued min-h-[2.25rem] px-2 py-1.5 rounded border border-secondary" %>
      <p class="text-xs text-secondary -mt-2"><%= t(".preferred_ai_model_hint") %></p>
      <%= form.submit t(".save"), class: "cursor-pointer" %>
    <% end %>
    <% if @family.errors.any? && params[:from] != "system_prompt" %>
      <div class="mt-3 rounded-lg border border-red-200 bg-red-50 p-3 text-sm text-red-800">
        <%= @family.errors.full_messages.to_sentence %>
      </div>
    <% end %>
  </div>
</div>

<%# Section: Provider-specific prompts (OpenAI only when selection is OpenAI) %>
<% if @show_openai_prompts %>
  <div class="bg-container rounded-xl shadow-border-xs p-4">
    <div class="rounded-xl bg-container-inset space-y-1 p-1">
      <div class="flex items-center gap-1.5 px-4 py-2 text-xs font-medium text-secondary">
        <p><%= t(".openai_label") %></p>
      </div>

      <div class="bg-container rounded-lg shadow-border-xs">
        <div class="space-y-0 divide-y divide-primary/10">
          <%# Main System Prompt — editable %>
          <div class="p-4 space-y-3">
            <div class="flex flex-wrap items-center gap-3">
              <div class="w-9 h-9 rounded-full bg-gray-25 flex justify-center items-center shrink-0">
                <%= icon "message-circle" %>
              </div>
              <div class="min-w-0 flex-1">
                <p class="text-sm font-medium text-primary"><%= t(".main_system_prompt.title") %></p>
                <p class="text-xs text-secondary"><%= t(".main_system_prompt.subtitle") %></p>
              </div>
              <details class="group open:w-full open:basis-full open:order-10">
                <summary class="cursor-pointer text-xs font-medium text-primary uppercase flex items-center gap-1 hover:underline w-fit">
                  <%= t(".prompt_link") %>
                  <%= icon "chevron-right", class: "w-3 h-3 group-open:rotate-90" %>
                </summary>
                <div class="mt-2 pt-2 border-t border-primary/10 w-full min-w-0 overflow-hidden">
                  <p class="text-xs text-secondary mb-1">[<%= @effective_model %>]</p>
                  <div class="px-3 py-2 bg-surface-default border border-primary/20 rounded-lg w-full min-w-0 overflow-x-auto">
                    <pre class="ai-prompt-pre text-xs font-mono text-primary"><%= Assistant.config_for(OpenStruct.new(user: Current.user))[:instructions] %></pre>
                  </div>
                </div>
              </details>
              <%= link_to t(".edit_prompt_link"), edit_system_prompt_settings_ai_prompts_path, class: "text-xs font-medium text-primary uppercase hover:underline shrink-0" %>
            </div>
          </div>

          <%# Transaction Categorizer — coming soon %>
          <div class="p-4 space-y-3">
            <div class="flex flex-wrap items-center gap-3">
              <div class="w-9 h-9 rounded-full bg-gray-25 flex justify-center items-center shrink-0">
                <%= icon "brain" %>
              </div>
              <div class="min-w-0 flex-1">
                <p class="text-sm font-medium text-primary"><%= t(".transaction_categorizer.title") %></p>
                <p class="text-xs text-secondary"><%= t(".transaction_categorizer.subtitle") %></p>
              </div>
              <details class="group open:w-full open:basis-full open:order-10">
                <summary class="cursor-pointer text-xs font-medium text-primary uppercase flex items-center gap-1 hover:underline w-fit">
                  <%= t(".prompt_link") %>
                  <%= icon "chevron-right", class: "w-3 h-3 group-open:rotate-90" %>
                </summary>
                <div class="mt-2 pt-2 border-t border-primary/10 w-full min-w-0 overflow-hidden">
                  <p class="text-xs text-secondary mb-1">[<%= @effective_model %>]</p>
                  <div class="px-3 py-2 bg-surface-default border border-primary/20 rounded-lg w-full min-w-0 overflow-x-auto">
                    <pre class="ai-prompt-pre text-xs font-mono text-primary"><%= @assistant_config[:auto_categorizer]&.instructions || Provider::Openai::AutoCategorizer.new(nil).instructions %></pre>
                  </div>
                </div>
              </details>
              <span class="text-xs font-medium text-secondary uppercase shrink-0"><%= t(".edit_prompt_coming_soon") %></span>
            </div>
          </div>

          <%# Merchant Detector — coming soon %>
          <div class="p-4 space-y-3">
            <div class="flex flex-wrap items-center gap-3">
              <div class="w-9 h-9 rounded-full bg-gray-25 flex justify-center items-center shrink-0">
                <%= icon "store" %>
              </div>
              <div class="min-w-0 flex-1">
                <p class="text-sm font-medium text-primary"><%= t(".merchant_detector.title") %></p>
                <p class="text-xs text-secondary"><%= t(".merchant_detector.subtitle") %></p>
              </div>
              <details class="group open:w-full open:basis-full open:order-10">
                <summary class="cursor-pointer text-xs font-medium text-primary uppercase flex items-center gap-1 hover:underline w-fit">
                  <%= t(".prompt_instructions") %>
                  <%= icon "chevron-right", class: "w-3 h-3 group-open:rotate-90" %>
                </summary>
                <div class="mt-2 pt-2 border-t border-primary/10 w-full min-w-0 overflow-hidden">
                  <p class="text-xs text-secondary mb-1">[<%= @effective_model %>]</p>
                  <div class="px-3 py-2 bg-surface-default border border-primary/20 rounded-lg w-full min-w-0 overflow-x-auto">
                    <pre class="ai-prompt-pre text-xs font-mono text-primary"><%= @assistant_config[:auto_merchant]&.instructions || Provider::Openai::AutoMerchantDetector.new(nil, model: "", transactions: [], user_merchants: []).instructions %></pre>
                  </div>
                </div>
              </details>
              <span class="text-xs font-medium text-secondary uppercase shrink-0"><%= t(".edit_prompt_coming_soon") %></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
<% else %>
  <div class="bg-container rounded-xl shadow-border-xs p-4">
    <p class="text-sm text-secondary"><%= t(".provider_prompts_hidden") %></p>
  </div>
<% end %>
