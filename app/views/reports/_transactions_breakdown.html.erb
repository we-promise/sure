<div>
  <%# Header %>
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-lg font-medium text-primary">
      <%= t("reports.transactions_breakdown.title") %>
    </h2>
  </div>

  <%# Filters %>
  <div class="mb-4" data-controller="filters">
    <details class="group">
      <summary class="cursor-pointer flex items-center gap-2 text-sm font-medium text-secondary hover:text-primary">
        <%= icon("filter", class: "w-4 h-4") %>
        <%= t("reports.transactions_breakdown.filters.title") %>
        <%= icon("chevron-down", class: "w-4 h-4 transition-transform group-open:rotate-180") %>
      </summary>

      <div class="mt-4 p-4 bg-surface-inset rounded-lg space-y-4">
        <%= form_with url: reports_path, method: :get, class: "space-y-4" do |f| %>
          <%# Preserve existing params %>
          <%= f.hidden_field :period_type, value: period_type %>
          <%= f.hidden_field :start_date, value: start_date %>
          <%= f.hidden_field :end_date, value: end_date %>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <%# Category Filter %>
            <div>
              <label class="block text-sm font-medium text-secondary mb-1">
                <%= t("reports.transactions_breakdown.filters.category") %>
              </label>
              <%= f.select :filter_category_id,
                          options_for_select(
                            [[t("reports.transactions_breakdown.filters.all_categories"), ""]] +
                            Current.family.categories.order(:name).map { |c| [c.name, c.id] },
                            params[:filter_category_id]
                          ),
                          {},
                          class: "w-full px-3 py-2 border border-primary rounded-lg text-sm" %>
            </div>

            <%# Account Filter %>
            <div>
              <label class="block text-sm font-medium text-secondary mb-1">
                <%= t("reports.transactions_breakdown.filters.account") %>
              </label>
              <%= f.select :filter_account_id,
                          options_for_select(
                            [[t("reports.transactions_breakdown.filters.all_accounts"), ""]] +
                            Current.family.accounts.order(:name).map { |a| [a.name, a.id] },
                            params[:filter_account_id]
                          ),
                          {},
                          class: "w-full px-3 py-2 border border-primary rounded-lg text-sm" %>
            </div>

            <%# Tag Filter %>
            <div>
              <label class="block text-sm font-medium text-secondary mb-1">
                <%= t("reports.transactions_breakdown.filters.tag") %>
              </label>
              <%= f.select :filter_tag_id,
                          options_for_select(
                            [[t("reports.transactions_breakdown.filters.all_tags"), ""]] +
                            Current.family.tags.order(:name).map { |t| [t.name, t.id] },
                            params[:filter_tag_id]
                          ),
                          {},
                          class: "w-full px-3 py-2 border border-primary rounded-lg text-sm" %>
            </div>

            <%# Amount Min %>
            <div>
              <label class="block text-sm font-medium text-secondary mb-1">
                <%= t("reports.transactions_breakdown.filters.amount_min") %>
              </label>
              <%= f.number_field :filter_amount_min,
                                value: params[:filter_amount_min],
                                step: 0.01,
                                placeholder: "0.00",
                                class: "w-full px-3 py-2 border border-primary rounded-lg text-sm" %>
            </div>

            <%# Amount Max %>
            <div>
              <label class="block text-sm font-medium text-secondary mb-1">
                <%= t("reports.transactions_breakdown.filters.amount_max") %>
              </label>
              <%= f.number_field :filter_amount_max,
                                value: params[:filter_amount_max],
                                step: 0.01,
                                placeholder: "0.00",
                                class: "w-full px-3 py-2 border border-primary rounded-lg text-sm" %>
            </div>

            <%# Date Range %>
            <div>
              <label class="block text-sm font-medium text-secondary mb-1">
                <%= t("reports.transactions_breakdown.filters.date_range") %>
              </label>
              <div class="flex gap-2">
                <%= f.date_field :filter_date_start,
                                value: params[:filter_date_start],
                                class: "w-full px-3 py-2 border border-primary rounded-lg text-sm" %>
                <span class="text-secondary">â€”</span>
                <%= f.date_field :filter_date_end,
                                value: params[:filter_date_end],
                                class: "w-full px-3 py-2 border border-primary rounded-lg text-sm" %>
              </div>
            </div>
          </div>

          <div class="flex gap-2">
            <%= f.submit t("reports.transactions_breakdown.filters.apply"),
                        class: "px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-700 text-sm" %>
            <%= link_to t("reports.transactions_breakdown.filters.clear"),
                        reports_path(period_type: period_type, start_date: start_date, end_date: end_date),
                        class: "px-4 py-2 border border-primary text-primary rounded-lg hover:bg-surface-inset text-sm" %>
          </div>
        <% end %>
      </div>
    </details>
  </div>

  <%# Sort and Export Controls %>
  <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
    <%
      # Build params hash for links
      base_params = {
        period_type: period_type,
        start_date: start_date,
        end_date: end_date,
        filter_category_id: params[:filter_category_id],
        filter_account_id: params[:filter_account_id],
        filter_tag_id: params[:filter_tag_id],
        filter_amount_min: params[:filter_amount_min],
        filter_amount_max: params[:filter_amount_max],
        filter_date_start: params[:filter_date_start],
        filter_date_end: params[:filter_date_end]
      }.compact
    %>

    <%# Sort Options %>
    <div class="flex items-center gap-2">
      <span class="text-sm text-secondary"><%= t("reports.transactions_breakdown.sort.label") %>:</span>
      <%= link_to t("reports.transactions_breakdown.sort.date_desc"),
                  reports_path(base_params.merge(sort_by: "date", sort_direction: "desc")),
                  class: "text-sm px-3 py-1 rounded-lg #{params[:sort_by] == 'date' && params[:sort_direction] == 'desc' ? 'bg-gray-900 text-white' : 'bg-surface-inset text-secondary hover:bg-gray-200'}" %>
      <%= link_to t("reports.transactions_breakdown.sort.amount_desc"),
                  reports_path(base_params.merge(sort_by: "amount", sort_direction: "desc")),
                  class: "text-sm px-3 py-1 rounded-lg #{params[:sort_by] == 'amount' && params[:sort_direction] == 'desc' ? 'bg-gray-900 text-white' : 'bg-surface-inset text-secondary hover:bg-gray-200'}" %>
      <%= link_to t("reports.transactions_breakdown.sort.amount_asc"),
                  reports_path(base_params.merge(sort_by: "amount", sort_direction: "asc")),
                  class: "text-sm px-3 py-1 rounded-lg #{params[:sort_by] == 'amount' && params[:sort_direction] == 'asc' ? 'bg-gray-900 text-white' : 'bg-surface-inset text-secondary hover:bg-gray-200'}" %>
    </div>

    <%# Export Options %>
    <div class="flex items-center gap-2">
      <span class="text-sm text-secondary"><%= t("reports.transactions_breakdown.export.label") %>:</span>
      <%= link_to export_transactions_reports_path(base_params.merge(format: :csv)),
                  class: "inline-flex items-center gap-1 text-sm px-3 py-1 bg-surface-inset text-secondary hover:bg-gray-200 rounded-lg" do %>
        <%= icon("download", class: "w-3 h-3") %>
        <span><%= t("reports.transactions_breakdown.export.csv") %></span>
      <% end %>
      <%
        # Build Google Sheets URL with IMPORTDATA formula
        csv_url = export_transactions_reports_path(base_params.merge(format: :csv, host: request.base_url))
        sheets_url = "https://docs.google.com/spreadsheets/d/create?usp=chrome_ext&template=custom"
      %>
      <%= link_to sheets_url,
                  target: "_blank",
                  rel: "noopener",
                  class: "inline-flex items-center gap-1 text-sm px-3 py-1 bg-surface-inset text-secondary hover:bg-gray-200 rounded-lg",
                  data: {
                    controller: "google-sheets",
                    google_sheets_csv_url_value: url_for(base_params.merge(format: :csv, only_path: false))
                  } do %>
        <%= icon("external-link", class: "w-3 h-3") %>
        <span><%= t("reports.transactions_breakdown.export.google_sheets") %></span>
      <% end %>
    </div>
  </div>

  <%# Transactions Tables - Split by Income and Expenses %>
  <% if transactions.any? %>
    <%
      # Separate income and expenses
      income_groups = transactions.select { |g| g[:type] == "income" }
      expense_groups = transactions.select { |g| g[:type] == "expense" }

      # Calculate totals
      income_total = income_groups.sum { |g| g[:total] }
      expense_total = expense_groups.sum { |g| g[:total] }
    %>

    <div class="space-y-8">
      <%# Income Section %>
      <% if income_groups.any? %>
        <div>
          <h3 class="text-base font-semibold text-success mb-4 flex items-center gap-2">
            <%= icon("trending-up", class: "w-5 h-5") %>
            <%= t("reports.transactions_breakdown.table.income") %>
            <span class="text-sm font-normal text-tertiary">(<%= Money.new(income_total, Current.family.currency).format %>)</span>
          </h3>

          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="border-b border-tertiary">
                  <th class="text-left py-3 pr-4 font-medium text-secondary"><%= t("reports.transactions_breakdown.table.category") %></th>
                  <th class="text-right py-3 px-4 font-medium text-secondary"><%= t("reports.transactions_breakdown.table.amount") %></th>
                  <th class="text-right py-3 pl-4 font-medium text-secondary"><%= t("reports.transactions_breakdown.table.percentage") %></th>
                </tr>
              </thead>
              <tbody>
                <% income_groups.each do |group| %>
                  <% percentage = income_total.zero? ? 0 : (group[:total].to_f / income_total * 100).round(1) %>
                  <tr class="border-b border-tertiary hover:bg-surface-inset">
                    <td class="py-3 pr-4">
                      <div class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full flex-shrink-0" style="background-color: <%= group[:category_color] %>"></span>
                        <span class="font-medium text-primary"><%= group[:category_name] %></span>
                        <span class="text-xs text-tertiary whitespace-nowrap">(<%= group[:count] %> <%= t("reports.transactions_breakdown.table.transactions") %>)</span>
                      </div>
                    </td>
                    <td class="py-3 px-4 text-right">
                      <span class="font-semibold text-green-600">
                        <%= Money.new(group[:total], Current.family.currency).format %>
                      </span>
                    </td>
                    <td class="py-3 pl-4 text-right">
                      <span class="text-sm text-secondary">
                        <%= percentage %>%
                      </span>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      <% end %>

      <%# Expenses Section %>
      <% if expense_groups.any? %>
        <div>
          <h3 class="text-base font-semibold text-danger mb-4 flex items-center gap-2">
            <%= icon("trending-down", class: "w-5 h-5") %>
            <%= t("reports.transactions_breakdown.table.expense") %>
            <span class="text-sm font-normal text-tertiary">(<%= Money.new(expense_total, Current.family.currency).format %>)</span>
          </h3>

          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="border-b border-tertiary">
                  <th class="text-left py-3 pr-4 font-medium text-secondary"><%= t("reports.transactions_breakdown.table.category") %></th>
                  <th class="text-right py-3 px-4 font-medium text-secondary"><%= t("reports.transactions_breakdown.table.amount") %></th>
                  <th class="text-right py-3 pl-4 font-medium text-secondary"><%= t("reports.transactions_breakdown.table.percentage") %></th>
                </tr>
              </thead>
              <tbody>
                <% expense_groups.each do |group| %>
                  <% percentage = expense_total.zero? ? 0 : (group[:total].to_f / expense_total * 100).round(1) %>
                  <tr class="border-b border-tertiary hover:bg-surface-inset">
                    <td class="py-3 pr-4">
                      <div class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full flex-shrink-0" style="background-color: <%= group[:category_color] %>"></span>
                        <span class="font-medium text-primary"><%= group[:category_name] %></span>
                        <span class="text-xs text-tertiary whitespace-nowrap">(<%= group[:count] %> <%= t("reports.transactions_breakdown.table.transactions") %>)</span>
                      </div>
                    </td>
                    <td class="py-3 px-4 text-right">
                      <span class="font-semibold text-red-600">
                        <%= Money.new(group[:total], Current.family.currency).format %>
                      </span>
                    </td>
                    <td class="py-3 pl-4 text-right">
                      <span class="text-sm text-secondary">
                        <%= percentage %>%
                      </span>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      <% end %>
    </div>

    <%# Summary Stats %>
    <div class="mt-4 text-sm text-secondary">
      <%= t("reports.transactions_breakdown.pagination.showing", count: transactions.sum { |g| g[:count] }) %>
    </div>
  <% else %>
    <div class="text-center py-8 text-tertiary">
      <%= t("reports.transactions_breakdown.no_transactions") %>
    </div>
  <% end %>
</div>
