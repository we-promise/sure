<% content_for :title do %>
  <%= t("reports.print.document_title") %> - <%= @start_date.strftime("%b %d, %Y") %> to <%= @end_date.strftime("%b %d, %Y") %>
<% end %>

<%
  # Helper to generate sparkline SVG path
  def sparkline_path(values, width: 60, height: 16)
    return "" if values.empty? || values.all?(&:zero?)
    max_val = values.max.to_f
    min_val = values.min.to_f
    range = max_val - min_val
    range = 1 if range.zero?

    points = values.each_with_index.map do |val, i|
      x = (i.to_f / (values.length - 1)) * width
      y = height - ((val - min_val) / range * height)
      "#{x.round(1)},#{y.round(1)}"
    end
    points.join(" ")
  end
%>

<div class="tufte-report">
  <%# Compact Header %>
  <header class="tufte-header">
    <h1 class="tufte-title">
      <%= t("reports.print.title") %>
      <span class="tufte-period">(<%= @start_date.strftime("%b %d") %> – <%= @end_date.strftime("%b %d, %Y") %>)</span>
    </h1>
    <p class="tufte-meta"><%= Current.family.name %> · Generated <%= Time.current.strftime("%b %d, %Y") %></p>
  </header>

  <%# Summary - Inline metrics with sparklines %>
  <section class="tufte-section">
    <div class="tufte-summary">
      <div class="tufte-metric">
        <span class="tufte-metric-label">Income</span>
        <span class="tufte-metric-value tufte-income"><%= @summary_metrics[:current_income].format %></span>
        <% if @summary_metrics[:income_change] && @summary_metrics[:income_change] != 0 %>
          <span class="tufte-metric-change <%= @summary_metrics[:income_change] >= 0 ? 'tufte-up' : 'tufte-down' %>">
            <%= @summary_metrics[:income_change] >= 0 ? "▲" : "▼" %><%= @summary_metrics[:income_change].abs %>%
          </span>
        <% end %>
        <% if @trends_data.any? %>
          <svg class="tufte-sparkline" viewBox="0 0 60 16" preserveAspectRatio="none">
            <polyline points="<%= sparkline_path(@trends_data.map { |t| t[:income] }) %>" fill="none" stroke="#10a861" stroke-width="1.5"/>
          </svg>
        <% end %>
      </div>

      <div class="tufte-metric">
        <span class="tufte-metric-label">Expenses</span>
        <span class="tufte-metric-value tufte-expense"><%= @summary_metrics[:current_expenses].format %></span>
        <% if @summary_metrics[:expense_change] && @summary_metrics[:expense_change] != 0 %>
          <span class="tufte-metric-change <%= @summary_metrics[:expense_change] >= 0 ? 'tufte-down' : 'tufte-up' %>">
            <%= @summary_metrics[:expense_change] >= 0 ? "▲" : "▼" %><%= @summary_metrics[:expense_change].abs %>%
          </span>
        <% end %>
        <% if @trends_data.any? %>
          <svg class="tufte-sparkline" viewBox="0 0 60 16" preserveAspectRatio="none">
            <polyline points="<%= sparkline_path(@trends_data.map { |t| t[:expenses] }) %>" fill="none" stroke="#ec2222" stroke-width="1.5"/>
          </svg>
        <% end %>
      </div>

      <div class="tufte-metric">
        <span class="tufte-metric-label">Net</span>
        <span class="tufte-metric-value <%= @summary_metrics[:net_savings] >= 0 ? 'tufte-income' : 'tufte-expense' %>"><%= @summary_metrics[:net_savings].format %></span>
        <% if @trends_data.any? %>
          <svg class="tufte-sparkline" viewBox="0 0 60 16" preserveAspectRatio="none">
            <polyline points="<%= sparkline_path(@trends_data.map { |t| t[:net] }) %>" fill="none" stroke="<%= @summary_metrics[:net_savings] >= 0 ? '#10a861' : '#ec2222' %>" stroke-width="1.5"/>
          </svg>
        <% end %>
      </div>

      <% if @summary_metrics[:budget_percent] %>
        <div class="tufte-metric">
          <span class="tufte-metric-label">Budget</span>
          <span class="tufte-metric-value"><%= @summary_metrics[:budget_percent] %>%</span>
          <span class="tufte-metric-note">used</span>
        </div>
      <% end %>
    </div>
  </section>

  <%# Net Worth - Compact layout %>
  <% if Current.family.accounts.any? %>
    <section class="tufte-section">
      <h2 class="tufte-section-title">Net Worth</h2>
      <div class="tufte-networth">
        <span class="tufte-networth-value <%= @net_worth_metrics[:current_net_worth] >= 0 ? 'tufte-income' : 'tufte-expense' %>">
          <%= @net_worth_metrics[:current_net_worth].format %>
        </span>
        <% if @net_worth_metrics[:trend] %>
          <span class="tufte-networth-change" style="color: <%= @net_worth_metrics[:trend].color %>">
            <%= @net_worth_metrics[:trend].value.format(signify_positive: true) %> (<%= @net_worth_metrics[:trend].percent_formatted %>)
          </span>
        <% end %>
      </div>

      <div class="tufte-two-col">
        <div>
          <h3 class="tufte-subsection tufte-income">Assets <%= @net_worth_metrics[:total_assets].format %></h3>
          <% if @net_worth_metrics[:asset_groups].any? %>
            <table class="tufte-table tufte-compact">
              <tbody>
                <% @net_worth_metrics[:asset_groups].each do |group| %>
                  <tr>
                    <td><%= group[:name] %></td>
                    <td class="tufte-right tufte-income"><%= group[:total].format %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          <% end %>
        </div>
        <div>
          <h3 class="tufte-subsection tufte-expense">Liabilities <%= @net_worth_metrics[:total_liabilities].format %></h3>
          <% if @net_worth_metrics[:liability_groups].any? %>
            <table class="tufte-table tufte-compact">
              <tbody>
                <% @net_worth_metrics[:liability_groups].each do |group| %>
                  <tr>
                    <td><%= group[:name] %></td>
                    <td class="tufte-right tufte-expense"><%= group[:total].format %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          <% end %>
        </div>
      </div>
    </section>
  <% end %>

  <%# Trends - Dense table %>
  <% if @trends_data.any? %>
    <section class="tufte-section">
      <h2 class="tufte-section-title">Monthly Trends</h2>
      <table class="tufte-table">
        <thead>
          <tr>
            <th>Month</th>
            <th class="tufte-right">Income</th>
            <th class="tufte-right">Expenses</th>
            <th class="tufte-right">Net</th>
            <th class="tufte-right">Rate</th>
          </tr>
        </thead>
        <tbody>
          <% @trends_data.each do |trend| %>
            <tr class="<%= trend[:is_current_month] ? 'tufte-highlight' : '' %>">
              <td><%= trend[:month] %><%= trend[:is_current_month] ? '*' : '' %></td>
              <td class="tufte-right tufte-income"><%= Money.new(trend[:income], Current.family.currency).format %></td>
              <td class="tufte-right tufte-expense"><%= Money.new(trend[:expenses], Current.family.currency).format %></td>
              <td class="tufte-right <%= trend[:net] >= 0 ? 'tufte-income' : 'tufte-expense' %>"><%= Money.new(trend[:net], Current.family.currency).format %></td>
              <td class="tufte-right">
                <% savings_rate = trend[:income] > 0 ? ((trend[:net].to_f / trend[:income].to_f) * 100).round(0) : 0 %>
                <%= savings_rate %>%
              </td>
            </tr>
          <% end %>
        </tbody>
        <tfoot>
          <% avg_income = @trends_data.sum { |t| t[:income] } / @trends_data.length %>
          <% avg_expenses = @trends_data.sum { |t| t[:expenses] } / @trends_data.length %>
          <% avg_net = @trends_data.sum { |t| t[:net] } / @trends_data.length %>
          <tr>
            <td><em>Avg</em></td>
            <td class="tufte-right tufte-income"><%= Money.new(avg_income, Current.family.currency).format %></td>
            <td class="tufte-right tufte-expense"><%= Money.new(avg_expenses, Current.family.currency).format %></td>
            <td class="tufte-right <%= avg_net >= 0 ? 'tufte-income' : 'tufte-expense' %>"><%= Money.new(avg_net, Current.family.currency).format %></td>
            <td class="tufte-right"><%= avg_income > 0 ? ((avg_net.to_f / avg_income.to_f) * 100).round(0) : 0 %>%</td>
          </tr>
        </tfoot>
      </table>
      <p class="tufte-footnote">* Current month (partial data)</p>
    </section>
  <% end %>

  <%# Investments - Compact %>
  <% if @investment_metrics[:has_investments] %>
    <section class="tufte-section">
      <h2 class="tufte-section-title">Investments</h2>
      <div class="tufte-summary">
        <div class="tufte-metric">
          <span class="tufte-metric-label">Portfolio</span>
          <span class="tufte-metric-value"><%= format_money(@investment_metrics[:portfolio_value]) %></span>
        </div>
        <% if @investment_metrics[:unrealized_trend] %>
          <div class="tufte-metric">
            <span class="tufte-metric-label">Return</span>
            <span class="tufte-metric-value" style="color: <%= @investment_metrics[:unrealized_trend].color %>">
              <%= format_money(Money.new(@investment_metrics[:unrealized_trend].value, Current.family.currency)) %>
            </span>
            <span class="tufte-metric-note"><%= @investment_metrics[:unrealized_trend].percent_formatted %></span>
          </div>
        <% end %>
        <div class="tufte-metric">
          <span class="tufte-metric-label">In/Out</span>
          <span class="tufte-metric-value">
            +<%= format_money(@investment_metrics[:period_contributions]) %> / −<%= format_money(@investment_metrics[:period_withdrawals]) %>
          </span>
        </div>
      </div>

      <% if @investment_metrics[:top_holdings].any? %>
        <h3 class="tufte-subsection">Top Holdings</h3>
        <table class="tufte-table tufte-compact">
          <thead>
            <tr>
              <th>Holding</th>
              <th class="tufte-right">Weight</th>
              <th class="tufte-right">Value</th>
              <th class="tufte-right">Return</th>
            </tr>
          </thead>
          <tbody>
            <% @investment_metrics[:top_holdings].each do |holding| %>
              <tr>
                <td><strong><%= holding.ticker %></strong> <span class="tufte-muted"><%= truncate(holding.name, length: 20) %></span></td>
                <td class="tufte-right"><%= number_to_percentage(holding.weight || 0, precision: 1) %></td>
                <td class="tufte-right"><%= format_money(holding.amount_money) %></td>
                <td class="tufte-right">
                  <% if holding.trend %>
                    <span style="color: <%= holding.trend.color %>"><%= holding.trend.percent_formatted %></span>
                  <% else %>—<% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% end %>
    </section>
  <% end %>

  <%# Activity Breakdown - Two column layout %>
  <% if @transactions.any? %>
    <section class="tufte-section tufte-keep-together">
      <h2 class="tufte-section-title">Activity Breakdown</h2>
      <%
        income_groups = @transactions.select { |g| g[:type] == "income" }
        expense_groups = @transactions.select { |g| g[:type] == "expense" }
        income_total = income_groups.sum { |g| g[:total] }
        expense_total = expense_groups.sum { |g| g[:total] }
      %>

      <div class="tufte-two-col">
        <% if income_groups.any? %>
          <div>
            <h3 class="tufte-subsection tufte-income">Income <%= Money.new(income_total, Current.family.currency).format %></h3>
            <table class="tufte-table tufte-compact">
              <tbody>
                <% income_groups.each do |group| %>
                  <% percentage = income_total.zero? ? 0 : (group[:total].to_f / income_total * 100).round(0) %>
                  <tr>
                    <td>
                      <span class="tufte-dot" style="background: <%= group[:category_color] %>"></span>
                      <%= group[:category_name] %>
                    </td>
                    <td class="tufte-right tufte-income"><%= Money.new(group[:total], Current.family.currency).format %></td>
                    <td class="tufte-right tufte-muted"><%= percentage %>%</td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% end %>

        <% if expense_groups.any? %>
          <div>
            <h3 class="tufte-subsection tufte-expense">Expenses <%= Money.new(expense_total, Current.family.currency).format %></h3>
            <table class="tufte-table tufte-compact">
              <tbody>
                <% expense_groups.each do |group| %>
                  <% percentage = expense_total.zero? ? 0 : (group[:total].to_f / expense_total * 100).round(0) %>
                  <tr>
                    <td>
                      <span class="tufte-dot" style="background: <%= group[:category_color] %>"></span>
                      <%= group[:category_name] %>
                    </td>
                    <td class="tufte-right tufte-expense"><%= Money.new(group[:total], Current.family.currency).format %></td>
                    <td class="tufte-right tufte-muted"><%= percentage %>%</td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% end %>
      </div>
    </section>
  <% end %>

  <footer class="tufte-footer">
    <%= product_name %> · <%= Time.current.strftime("%Y") %>
  </footer>
</div>
