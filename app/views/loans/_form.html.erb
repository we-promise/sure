<%# locals: (account:, url:) %>
<% if @error_message.present? %>
  <%= render DS::Alert.new(message: @error_message, variant: :error) %>
<% end %>
<%= styled_form_with model: account, url: url, scope: :account, data: { turbo: false }, class: "flex flex-col gap-4 justify-between grow text-primary" do |form| %>
  <%= form.hidden_field :accountable_type %>
  <%= form.hidden_field :return_to, value: params[:return_to] %>
  <div class="grow space-y-2">
    <%# Account Name %>
    <%= form.text_field :name, placeholder: t("accounts.form.name_placeholder"), required: "required", label: t("accounts.form.name_label") %>
    <%# Balance (for non-linked accounts) %>
    <% unless account.linked? %>
      <%= form.money_field :balance, label: t("accounts.form.balance"), required: true, default_currency: Current.family.currency %>
    <% end %>
    <%= render "shared/ruler", classes: "my-2" %>
    <%# Loan-specific fields %>
    <%= form.fields_for :accountable do |loan_form| %>
      <div class="flex items-center gap-2">
        <%= loan_form.money_field :initial_balance,
                                 label: t("loans.form.initial_balance"),
                                 default_currency: Current.family.currency,
                                 required: true %>
      </div>
      <div class="flex items-center gap-2">
        <%= loan_form.number_field :interest_rate,
                                 label: t("loans.form.interest_rate"),
                                 placeholder: t("loans.form.interest_rate_placeholder"),
                                 min: 0,
                                 step: 0.005 %>
        <%= loan_form.select :rate_type,
                           [["Fixed", "fixed"], ["Variable", "variable"], ["Adjustable", "adjustable"]],
                           { label: t("loans.form.rate_type") } %>
      </div>
      <div class="flex items-center gap-2">
        <%= loan_form.number_field :term_months,
                                 label: t("loans.form.term_months"),
                                 placeholder: t("loans.form.term_months_placeholder") %>
      </div>
    <% end %>
    <%# Additional Details (collapsed) %>
    <details class="group">
      <summary class="cursor-pointer text-sm text-secondary hover:text-primary flex items-center gap-1 py-2">
        <%= icon "chevron-right", size: "sm", class: "group-open:rotate-90 transition-transform" %>
        <%= t("accounts.form.additional_details") %>
      </summary>
      <div class="space-y-2 mt-2 pl-4 border-l border-primary">
        <%= form.text_field :institution_name,
            label: t("accounts.form.institution_name_label"),
            placeholder: account.provider&.institution_name || t("accounts.form.institution_name_placeholder") %>
        <%= form.text_field :institution_domain,
            label: t("accounts.form.institution_domain_label"),
            placeholder: account.provider&.institution_domain || t("accounts.form.institution_domain_placeholder") %>
        <%= form.text_area :notes,
            label: t("accounts.form.notes_label"),
            placeholder: t("accounts.form.notes_placeholder"),
            rows: 4 %>
      </div>
    </details>
  </div>
  <%= form.submit %>
<% end %>
