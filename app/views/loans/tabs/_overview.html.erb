<%# locals: (account:) %>

<% if account.installment.present? %>
  <div class="space-y-6 mb-6">
    <%# Installment Overview %>
    <%= render Installments::OverviewComponent.new(installment: account.installment) %>

    <%# Payment Schedule %>
    <div class="mt-6">
      <%= render Installments::PaymentScheduleComponent.new(installment: account.installment) %>
    </div>

    <%# Balance Comparison %>
    <div class="mt-6 p-4 bg-surface rounded-lg border border-surface-inset">
      <h3 class="text-sm font-medium mb-2 text-primary"><%= t("installments.balance_comparison.title") %></h3>
      <div class="space-y-2">
        <div class="flex justify-between">
          <span class="text-secondary"><%= t("installments.balance_comparison.calculated") %></span>
          <span class="font-medium text-primary"><%= format_money(account.installment.calculate_current_balance, currency: account.currency) %></span>
        </div>
        <div class="flex justify-between">
          <span class="text-secondary"><%= t("installments.balance_comparison.bank") %></span>
          <span class="font-medium text-primary"><%= format_money(account.balance_money) %></span>
        </div>
        <% balance_diff = (account.installment.calculate_current_balance - account.balance).abs %>
        <% if balance_diff > 1 %>
          <div class="text-xs text-yellow-700 flex items-start gap-1 mt-2 p-2 bg-yellow-50 rounded">
            <%= icon("info", size: "sm", class: "mt-0.5 flex-shrink-0") %>
            <span><%= t("installments.balance_comparison.mismatch_info") %></span>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

<div class="grid grid-cols-3 gap-2">
  <%= summary_card title: t(".original_principal") do %>
    <%= format_money account.loan.original_balance %>
  <% end %>

  <%= summary_card title: t(".remaining_principal") do %>
    <%= format_money account.balance_money %>
  <% end %>

  <%= summary_card title: t(".interest_rate") do %>
    <% if account.loan.interest_rate.present? %>
      <%= number_to_percentage(account.loan.interest_rate, precision: 3) %>
    <% else %>
      <%= t(".unknown") %>
    <% end %>
  <% end %>

  <%= summary_card title: t(".monthly_payment") do %>
    <% if account.loan.rate_type.present? && account.loan.rate_type != 'fixed' %>
      <%= t(".not_applicable") %>
    <% elsif account.loan.rate_type == 'fixed' && account.loan.monthly_payment.present? %>
      <%= format_money(account.loan.monthly_payment) %>
    <% else %>
      <%= t(".unknown") %>
    <% end %>
  <% end %>

  <%= summary_card title: t(".term") do %>
    <% if account.loan.term_months.present? %>
      <% if account.loan.term_months < 12 %>
        <%= pluralize(account.loan.term_months, "month") %>
      <% else %>
        <%= pluralize(account.loan.term_months / 12, "year") %>
      <% end %>
    <% else %>
      <%= t(".unknown") %>
    <% end %>
  <% end %>

  <%= summary_card title: t(".type") do %>
    <%= account.loan.rate_type&.titleize || t(".unknown") %>
  <% end %>
</div>

<div class="flex justify-center py-8">
  <%= render DS::Link.new(
    text: "Edit loan details",
    variant: "ghost",
    href: edit_loan_path(account),
    frame: :modal
  ) %>
</div>
